@page "/loginhelper"

@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Cookies
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims

@inject AuthHelper AuthHelper;
@inject FeedbackContext Сontext;
@inject IHttpContextAccessor HttpContextAccessor;
@inject NavigationManager NavigationManager;

@code {
    protected override void OnInitialized()
    {
        UserAccount? user = Сontext.UserAccounts.Include(x => x.UserAccountRoles).ThenInclude(x => x.Role).FirstOrDefault(x => x.Login == AuthHelper.Login);

        bool isAnonymous = user is null || !BCrypt.Net.BCrypt.Verify(AuthHelper.Password, user.PasswordHash);

        ClaimsPrincipal claimsPrincipal = isAnonymous ? GetAnonymous() : user.GetClaimsPrincipal();

        HttpContextAccessor.HttpContext.SignInAsync(claimsPrincipal);

        AuthHelper.Clear();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        NavigationManager.NavigateTo("/login", true);
    }

    private ClaimsPrincipal GetAnonymous() => new(new ClaimsIdentity(new List<Claim>(), CookieAuthenticationDefaults.AuthenticationScheme));
}