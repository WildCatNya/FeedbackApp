@page "/contacts/view"

@using System.Security.Claims

@inject FeedbackContext _context;

@attribute [Authorize]

@if (Contacts is null)
{
    <p>Загрузка...</p>
}
else if (!Contacts.Any())
{
    <p>Данных нет</p>
}
else
{
    @* <MudPaper Elevation="25">
        <MudToolBar>
            <CompleteSortButtons Contacts="SourceContacts" SortCallback="SortCallbackHandler" />
        </MudToolBar>
    </MudPaper> *@

    <MudTabs ApplyEffectsToContainer="true" Elevation="2" PanelClass="pa-6" Rounded="true">
        @foreach (var subjectGroup in Contacts.GroupBy(x => x.Subject.ShortValue).OrderBy(x => x.Key))
        {
            <MudTabPanel>
                <TabContent>
                    @{
                        int count = subjectGroup.Count(x => !x.IsCompleted);
                    }
                    <MudBadge Bordered="true" Color="Color.Primary" Content="@count" Overlap="true" Visible="@(count != 0)">@subjectGroup.Key</MudBadge>
                    </TabContent>
                    <ChildContent>
                        <MudGrid Justify="Justify.FlexStart">
                            @foreach (var contact in subjectGroup)
                        {
                            <MudItem xs="12" md="6" lg="4">
                                <ContactViewComponent Contact="@contact" StateChangeEventCallback="StateChangeEventCallbackHandler" />
                            </MudItem>
                        }
                    </MudGrid>
                </ChildContent>
            </MudTabPanel>
        }
    </MudTabs>
}

@code {
    [CascadingParameter] Task<AuthenticationState> AuthenticationStateTask { get; set; }

    private List<Contact>? Contacts = [];

    //private List<Contact>? Contacts;

    protected override async Task OnInitializedAsync()
    {
        AuthenticationState authenticationState = await AuthenticationStateTask;

        IEnumerable<Claim>? roleClaims = authenticationState.User.Claims.Where(x => x.Type.Contains("role"));

        if (roleClaims.Any())
        {
            var contacts = _context.Contacts.OrderByDescending(x => !x.IsCompleted).ThenByDescending(x => x.CreationTime);

            string[] roles = roleClaims.Select(x => x.Value).ToArray();

            if (RoleCheck(roles, RolesNames.Creator, RolesNames.Admin, RolesNames.AllSeeing))
            {
                bool allseeing = RoleCheck(roles, RolesNames.Creator, RolesNames.CanConceal);

                Contacts = await (allseeing ? contacts : contacts.Where(x => !x.Hide)).ToListAsync();
            }
            else
            {
                Contacts = await contacts.Where(contact => roles.Any(role => contact.Subject.Role.Name == role)).Where(x => !x.Hide).ToListAsync();
            }

            //SourceContacts = Contacts;
        }
    }

    private bool RoleCheck(string[] currentRoles, params string[] roles) =>
        currentRoles.Any(currentRole => roles.Any(role => currentRole == role));

    private void StateChangeEventCallbackHandler() => StateHasChanged();

    // private void SortCallbackHandler(List<Contact> sortedContacts)
    // {
    //     Contacts = sortedContacts;
    //     StateHasChanged();
    // }
}